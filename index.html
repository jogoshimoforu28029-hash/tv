import asyncio
import logging
import re
from aiohttp import ClientSession
from aiogram import Bot, Dispatcher, types, F
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from urllib.parse import quote
from config import BOT_TOKEN

# –¢–≤–æ—è —Å—Å—ã–ª–∫–∞ –Ω–∞ GitHub Pages
HTTPS_URL = "https://jogoshimoforu28029-hash.github.io/tv/" 

logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

async def search_torrents(query):
    """–ü–æ–∏—Å–∫ —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ (RuTracker/NNM/Rutor)"""
    safe_query = quote(query)
    url = f"https://torrent-api-py.vercel.app/api/v1/all/search?query={safe_query}"
    async with ClientSession() as session:
        try:
            async with session.get(url, timeout=10) as resp:
                if resp.status == 200:
                    data = await resp.json()
                    return sorted(data, key=lambda x: int(x.get('seeders', 0)) if str(x.get('seeders')).isdigit() else 0, reverse=True)[:5]
        except: return []
    return []

@dp.message(F.text.startswith("magnet:"))
async def fast_magnet(message: types.Message):
    url = f"{HTTPS_URL}?magnet={quote(message.text.strip())}"
    kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üé¨ –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–õ–ï–ï–†", web_app=WebAppInfo(url=url))]])
    await message.answer("üçø –°—Å—ã–ª–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ö–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ:", reply_markup=kb)

@dp.message(F.text)
async def search_handler(message: types.Message):
    if len(message.text) < 3: return
    m = await message.answer("üîé –ò—â—É –ª—É—á—à–∏–µ —Ä–∞–∑–¥–∞—á–∏...")
    results = await search_torrents(message.text)
    await m.delete()
    
    if not results:
        await message.answer("‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∏–ª–∏ —Å—Å—ã–ª–∫—É magnet.")
        return

    for t in results:
        url = f"{HTTPS_URL}?magnet={quote(t['magnet'])}"
        kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text=f"‚ñ∂Ô∏è –°–ú–û–¢–†–ï–¢–¨ ({t['size']})", web_app=WebAppInfo(url=url))]])
        await message.answer(f"üì¶ **{t['name'][:80]}**", reply_markup=kb, parse_mode="Markdown")

async def main():
    print("üöÄ –ë–û–¢ –û–ë–ù–û–í–õ–ï–ù. –ñ–î–ï–¢ –ó–ê–ü–†–û–°–û–í.")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
